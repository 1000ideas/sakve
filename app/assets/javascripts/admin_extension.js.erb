<% url = Sakve::Application.routes.url_helpers %>

var Helper = {
  split: function ( val ) {
    return val.split( /,\s*/ );
  },
  lastTerm: function ( term ) {
    return Helper.split( term ).pop();
  }
};

var LazyAdminExtension = {
  extension_setup: function() {
    $('.tags-autocomplete').autocomplete(this.tags_autocomplete_options);

    $('.fileupload').each(function() {
      LazyAdmin.fileupload_init(this);
    });

    $('.transfer-fileupload').each(function() {
      var uploader = $(this).parents('form');
      uploader.data('templates', {
        upload_progress: Mustache.compile( $('#upload_progress_template').text().trim() ),
        uploaded: Mustache.compile( $('#uploaded_template').text().trim() )
      });

      LazyAdmin.fileupload_init(this, {
        url: '<%= url.files_path(format: :json) %>',
        add: function(e, data) {
          var group = data.form.children('.group').first();
          var file = data.files[0];
          data.context = $( uploader.data('templates').upload_progress(file) );
          group.append( data.context );
          $("input[type=submit]", data.form).attr('disabled', true);
          data.submit();
        },
        progress: function(e, data) {
          if (data.context) {
            var progress = parseInt(data.loaded / data.total * 100, 10) + "%";
            $('.bar', data.context).css('width', progress)
            $('.progress-value', data.context).text( progress)
          }
        },
        done: function(e, data) {
          var uploaded = $( uploader.data('templates').uploaded({
            id: data.result.id,
            name: data.result.name,
            url: data.jqXHR.getResponseHeader('Location')
          }) );
          $('#uploaded-files').append( uploaded );
          data.context.remove();
        },
        stop: function(e) {
          $(this).parents('form').find("input[type=submit]").attr('disabled', false)
        }
      });
    });

  },
  tags_autocomplete_options: {
    source: function(request, response) {
      $.getJSON( "/tags.json", {
        q: Helper.lastTerm( request.term )
      }, response );
    },
    search: function() {
      var term = Helper.lastTerm( this.value );
      if ( term.length < 1 ) {
        return false;
      }
    },
    focus: function() {
      return false;
    },
    select: function( event, ui ) {
      var terms = Helper.split( this.value );
      terms.pop();
      terms.push( ui.item.value );
      terms.push( "" );
      this.value = terms.join( ", " );
      return false;
    }
  },
  fileupload_init: function(element, options) {
    if (!options) options = {};
    var value = $(element).data('value');
    $(element).wrap( $('<div>').addClass('button fileupload-button') );
    $(element).after( $('<span>').text( value ) );
    $(element).fileupload($.extend({
      singleFileUploads: true,
      dataType: 'json '
    }, options) );
  }
};


LazyAdmin = $.extend({}, LazyAdmin, LazyAdminExtension);
